## 1. Tổng quan về lỗi

### 1.1 Lỗi liên quan
- Nội dung lỗi
  - Khi đặt hebai và hủy đi về máy bay của application thì application sẽ xuất hiện trong mục 過去の予約 của tab 過去の予約. Trong khi đó hotel chưa bị hủy lại sẽ xuất hiện riêng biệt trong tab 過去の予約 của 現在の予約

- Mã số ticket liên quan
  - https://github.com/apple-world/tvl_air_issues/issues/796
  - https://github.com/apple-world/tvl_air_issues/issues/1894

- Phạm vi ảnh hưởng
  - Màn /application/list

### 1.2 Quy trình tái hiện lỗi
- Trên môi trường sand, book heibai, sau đó vào màn /application/list
- Khi flights chưa bị cancel, booking nằm ở tab 現在のご予約
- Cancel flights => booking chuyển về tab 過去の予約

### 1.3 Hành vi mong đợi
- Booking heibai chỉ chuyển về tab 過去の予約 khi thỏa mãn cả hai điều kiện:
  - Tất cả flights đều bị cancel hoặc departure date của tất cả flights đều ở trong quá khứ
  - Hotel bị cancel hoặc check out date < yesterday (logic code cũ)

## 2. Phân tích nguyên nhân

### 2.1 Nguyên nhân kỹ thuật
- Nguyên nhân do logic quyết định booking là current hay past hiện tại chỉ dựa trên departure time của flights, không dựa vào trạng thái của hotel.
  - Code liên quan: 
    - https://github.com/apple-world/tvl_api_django/blob/b75c4d1329afe790f24d4d23512a7c712f66c510/django_app/application/models/applications.py#L1357-L1361
    - https://github.com/apple-world/tvl_api_django/blob/8c4ec94f083ccc61464120f2aecdb9a5746ea82a/django_app/application/views/querysets.py#L32-L34
    - https://github.com/apple-world/tvl_api_django/blob/8c4ec94f083ccc61464120f2aecdb9a5746ea82a/django_app/application/views/querysets.py#L21-L29

### 2.2 Khảo sát ảnh hưởng
- Màn /application/list: ảnh hưởng đến hiển thị booking heibai nếu flight hoặc hotel bị cancel: user có thể nhầm lẫn về tính liên kết khi một trong hai bị cancel

## 3. Phương án sửa lỗi

### 3.1 Cách tiếp cận sửa lỗi
- Khi xử lí phân loại application là current hay past, sẽ cần xét thêm cả status của hotel với các application heibai bên BE.
- Phía BE: Lấy data hotel trong các application heibai qua call API `/api/v1/mypage/reservation`, dựa vào data hotel này để phân định booking thuộc current hay past.
- Phía FE: Chỉ call API `/api/v1/mypage/reservation` với các hotel không thuộc các application heibai, tránh call trùng lặp API.

### 3.2 Phạm vi sửa đổi
- Trong repo `api_django`:
  - Trong `application/serializers/applications.py`: Tạo serializer mới ApplicationsListSerializer cho response trả về từ API `/api/v1/applications/?status=current`: Với những application heibai, trả về cả data của hotel. Data hotel ở các application này được lấy từ call API `/api/v1/mypage/reservation`.

  - Trong `application/models/applications.py`: Update logic phân định application thuộc current hay past trong hàm `is_current`.

  - Trong `domestic_flight/models/tickets.py`: Update method `is_upcoming_departure`:
  ```
  return self.departure_datetime > datetime.now() and self.status
  ```
  - Update unit-test

- Trong repo `nuxt_web2`:
  - Trong `VoyagerHotel.js`: Update hàm `async references(fitId)`: chỉ trả về ref_no của hotel không thuộc application heibai (do các hotel này đã được xử lí trong Django ở trên).

  - Trong `list.vue`: 
    - Update hàm filteredBothFlightsAndHotels(): Sử dụng trực tiếp data hotel trả về từ Django

## 4. Kế hoạch kiểm thử

### 4.1 Trường hợp kiểm thử
- Kiểm thử xác nhận sửa lỗi
  - Book applications heibai, kiểm thử đối với các trường hợp sau:
    - 1 flight, 1 hotel:
      - Cancel chỉ flight hoặc chỉ hotel => expect booking ở tab 現在のご予約
      - Cancel cả flight cả hotel => expect booking ở tab 過去の予約
    - Nhiều flight, 1 hotel:
      - Tất cả flights và hotel đều cancel => expect booking ở tab 現在のご予約
      - Các trường hợp còn lại => expect booking ở tab 過去の予約
  - Các hotel đã hiển thị ở application heibai sẽ không hiển thị riêng lẻ trùng lặp nữa

- Kiểm thử hồi quy (regression test)
  - Kiểm tra thêm data hiển thị đối với các trang /detail

- Kiểm thử các trường hợp biên (edge cases)

### 4.2 Dữ liệu kiểm thử
- Các booking heibai, có thể được book dựa trên luồng book heibai thông thường

## 5. Estimation

### 5.1 Design (12h)
- Research + Investigate + Support time: 9h
- Create DD: 3h

### 5.2 Coding (9h?)
- Update `api_django`: 2h
  - Update unit-test (AI): ?h
- Update `nuxt_web2`: 3h
- Deploy + Self-test: 2.5h
- Code review + Fix bug: 2h

### 5.3 Testing

## 6. Kế hoạch phát hành

### 6.1 Quy trình deploy
- Quy trình triển khai
- Những lưu ý cần thiết
- Sự phụ thuộc theo thứ tự triển khai

### 6.2 Kiểm tra sau phát hành
- Mục tiêu xác nhận hoạt động
- Mục tiêu giám sát (monitoring)
- Tiêu chí rollback

## 7. Biện pháp phòng tránh tái phát

### 7.1 Biện pháp phòng ngừa
- Biện pháp ngăn chặn lỗi tương tự xảy ra
- Tăng cường giám sát
- Thiết lập cảnh báo

### 7.2 Cập nhật tài liệu
- Cập nhật tài liệu đặc tả
- Rà soát lại quy trình vận hành
- Sửa đổi hướng dẫn phát triển