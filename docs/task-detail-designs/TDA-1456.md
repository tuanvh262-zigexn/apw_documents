## 1. Tổng quan về lỗi

### 1.1 Lỗi liên quan
- Nội dung lỗi
  - Khi đặt `heibai` và hủy `flight` của `application` (`hotel` chưa bị huỷ) thì `application` sẽ xuất hiện trong tab `過去ご予約` (`past`). Trong khi đó `hotel` chưa bị hủy lại sẽ xuất hiện riêng biệt trong mục `国内ホテル` của tab `現在のご予約` (`current`), gây nhầm lẫn về tính liên kết.

- Mã số ticket liên quan
  - https://www.notion.so/appleworld/1ec71a08d38180ed8683d3a71dcb0901

- Phạm vi ảnh hưởng
  - Màn `/application/list`

### 1.2 Quy trình tái hiện lỗi
  ```mermaid
  sequenceDiagram
      participant User as User
      participant App as Travelist

      User->>App: Đặt vé `heibai`
      App-->>User: Đặt vé `heibai` thành công

      User->>App: Truy cập trang `/application/list`
      App-->>User: Tab `現在のご予約` chứa vé `heibai` vừa đặt

      User->>App: `Cancel` toàn bộ `flight` trong `application` `heibai`
      App-->>User: `Application` `heibai` sẽ ở tab `過去の予約`

  ```

### 1.3 Hành vi mong đợi
- `Application` `heibai` chỉ chuyển về tab `過去の予約` khi thỏa mãn cả hai điều kiện:
  - Tất cả `flights` đều bị `cancel` hoặc `departure date` của tất cả `flights` đều ở trong quá khứ
  - Hotel bị `cancel` hoặc check out `date < yesterday `(logic code cũ)

## 2. Phân tích nguyên nhân

### 2.1 Nguyên nhân kỹ thuật
- Nguyên nhân do logic quyết định `application` nằm ở tab `現在のご予約` hay tab `過去の予約` hiện tại chỉ dựa trên `departure time` của `flights`, không dựa vào trạng thái của `hotel`.
  - Code liên quan: 
    - https://github.com/apple-world/tvl_api_django/blob/b75c4d1329afe790f24d4d23512a7c712f66c510/django_app/application/models/applications.py#L1357-L1361
    - https://github.com/apple-world/tvl_api_django/blob/8c4ec94f083ccc61464120f2aecdb9a5746ea82a/django_app/application/views/querysets.py#L32-L34
    - https://github.com/apple-world/tvl_api_django/blob/8c4ec94f083ccc61464120f2aecdb9a5746ea82a/django_app/application/views/querysets.py#L21-L29

### 2.2 Khảo sát ảnh hưởng
- Màn `/application/list`: ảnh hưởng đến hiển thị `application` `heibai` nếu `flight` hoặc `hotel` bị `cancel`: user có thể nhầm lẫn về tính liên kết khi một trong hai bị cancel

## 3. Phương án sửa lỗi

### 3.1 Cách tiếp cận sửa lỗi
- Khi xử lí phân loại `application` nằm ở tab `現在のご予約` hay tab `過去の予約`, sẽ cần xét thêm cả `status` của `hotel` với các `application` `heibai` bên BE.

### 3.2 Phạm vi sửa đổi
- Trong repo `api_django`: 
  - Với API `/api/v1/applications/?status=current` và `/api/v1/applications/?status=past`,những `application` `heibai` sẽ trả về cả data của `hotel`.

  - Trong `application/models/applications.py`: Update logic phân định `application` nằm ở tab `現在のご予約` hay tab `過去の予約` trong hàm `is_current`, dựa vào cả `flight` và `hotel`

  - Trong `domestic_flight/models/tickets.py`: Update method `is_upcoming_departure`: Xét thêm status của `flight`
  ```
  return self.departure_datetime > datetime.now() and self.status
  ```
  - Update unit-test

- Trong repo `nuxt_web2`:
  - Trong `VoyagerHotel.js`: Update hàm `async references(fitId)`: chỉ trả về `ref_no` của `hotel` không thuộc `application` `heibai` (do các `hotel` này đã được xử lí trong Django ở trên).

  - Trong `list.vue`: 
    - Update hàm `filteredBothFlightsAndHotels()`: Sử dụng trực tiếp data `hotel` của `application` `heibai` trả về từ Django
    - Update hàm `filteredHotels()`: Sử dụng trực tiếp `this.hotels` do `this.hotels` không còn trả về `hotel` nằm trong `application` `heibai`

## 4. Kế hoạch kiểm thử

### 4.1 Trường hợp kiểm thử
- Kiểm thử xác nhận sửa lỗi
  - Book `applications` heibai, kiểm thử đối với các trường hợp sau:
    - 1 `flight`, 1 `hotel`:
      - Cancel chỉ `flight` hoặc chỉ `hotel` => expect `application` ở tab `現在のご予約`
      - Cancel cả `flight` cả `hotel` => expect `application` ở tab `過去の予約`
    - Nhiều `flight`, 1 `hotel`:
      - Tất cả `flights` và `hotel` đều `cancel` => expect `application` ở tab `現在のご予約`
      - Các trường hợp còn lại => expect `application` ở tab `過去の予約`
  - Các `hotel` đã hiển thị ở `application` `heibai` sẽ không hiển thị riêng lẻ trùng lặp nữa

- Kiểm thử hồi quy (regression test)
  - Kiểm tra thêm data hiển thị đối với các trang `/detail`

- Kiểm thử các trường hợp biên (edge cases)

### 4.2 Dữ liệu kiểm thử
- Các `application` `heibai`, có thể được đặt dựa trên luồng đặt vé `heibai` thông thường

## 5. Estimation

### 5.1 Design (12h)
- Research + Investigate + Support time: 9h
- Create DD: 3h

### 5.2 Coding (13h)
- Update `api_django`: 2.5h
- Update unit-test: 2.5h
- Update `nuxt_web2`: 3.5h
- Deploy + Self-test: 2.5h
- Code review + Fix bug: 2h

### 5.3 Testing

## 6. Kế hoạch phát hành

### 6.1 Quy trình deploy
- Quy trình triển khai
- Những lưu ý cần thiết
- Sự phụ thuộc theo thứ tự triển khai

### 6.2 Kiểm tra sau phát hành
- Mục tiêu xác nhận hoạt động
- Mục tiêu giám sát (monitoring)
- Tiêu chí rollback

## 7. Biện pháp phòng tránh tái phát

### 7.1 Biện pháp phòng ngừa
- Biện pháp ngăn chặn lỗi tương tự xảy ra
- Tăng cường giám sát
- Thiết lập cảnh báo

### 7.2 Cập nhật tài liệu
- Cập nhật tài liệu đặc tả
- Rà soát lại quy trình vận hành
- Sửa đổi hướng dẫn phát triển